# テストコード入門

## 日時
2020-06-18 

※PJに関連することは添削してます。

## 今回詳しく話さないこと
- テストの基本（境界値テスト等）
- 複合条件網羅（MCC)
- テスト駆動開発(TDD)
- 振る舞い駆動開発(BDD)
- DI(Dependency Injection)
- Mock

## テストコードとは
テストコードとは書いたプログラムについて、
そのロジックが想定通りの動きをしているか確認するためのプログラムです。

## テストコードのメリット・デメリット
### メリット
- 改修の際に影響あると思っていなかった部分で検知し事故を防ぐことができる
- →安心して リファクタリングがしやすくなる
- 他人が作ったコードでもテストコードの関数などの記述が適切ならばどのような機能なのか把握しやすくなる。（詳しくはBDD調べてください）
- テストしやすいコードは可読性が高い

### デメリット
- テストコード書くのは一般的に開発したコードの2−3倍かかるといわれる。
- メンテナンスされないとすぐにゴミになる。

## カバレッジとは
- テストの網羅率のこと。

- JUnit、phpUnitも、どれだけテストコードで処理を通っているかというのを見る。例えば100行あるメソッドがある場合に
 - =>「カバレッジ80%ならテストは80行は通っているけど20行は通っていないよ」という意味を指す。


## 命令網羅(C0カバレッジ)
それぞれの命令文が少なくとも1回は実行される ようにテストを設計します。
命令(＝処理)を網羅するイメージです。

```
function (int $a,int  $b)
  $c =0;
  if( $a > $b ){
    $c = $a + $b;①
  }else{
     ②
  }
  return $c;③
}

```

| パターン | $a | $b |
|:--:|:--:|:--:|
| 1 | 2 | 1 |

この場合に②を通る試験はしなくてもよいので1個で命令網羅はできる


## 分岐網羅(C1カバレッジ)
それぞれの判定条件における真偽が少なくとも1回は実行される ようにテストを設計します。
分岐(＝if分)を網羅するイメージです。

```
function (int $a,int  $b)
  $c =0;

  if( $a > $b ){
    $c = $a + $b;①
  }else{
    ②
  }
  return $c;③
}

```

| パターン | $a | $b |
|:--:|:--:|:--:|
| 1 | 2 | 1 |
| 2 | 1 | 2 |

分岐を網羅する必要があり②を通る必要があるためパターンとしては2個必要になります。

## 条件網羅(C2カバレッジ)
条件分岐内の条件を網羅するテストです。
分岐網羅との違いは、ANDやORで複数の条件が結ばれていても、それぞれを独立した条件と見なします。


```
function (int $a,int  $b, int $c)

  if( $a === 1 && $b === 1 && $c === 100){
    $c = $a + $b;①
  }else{
    ②
  }
  return $c;③

}
```
| パターン | $a | $b | $c |
|:--:|:--:|:--:|:--:|
| 1 | 1 | 1 | 100 |
| 2 | 1 | 1 | 99 |
| 3 | 1 | 2 | 99 |
| 4 | 2 | 2 | 99 |


## 複合条件網羅（MCC)
ややこしいので興味あれば調べてください。
実施はものすごーく大変で実施しているところ見たことないです。条件分岐ないのtrue,falseをすべて一個一個網羅するような形だった気がします。


```
function (int $a,int  $b, int $c)

  if( $a === 1 && $b === 1 && $c === 100){
    $c = $a + $b;①
  }else{
    ②
  }
  return $c;③
}

```
| パターン | $a | $b | $c |
|:--:|:--:|:--:|:--:|
| 1 | 1 | 1 | 100 |
| 2 | 2 | 1 | 100 |
| 3 | 2 | 2 | 100 |
| 4 | 1 | 1 | 99 |
| 5 | 2 | 1 | 99 |
| 6 | 2 | 2 | 99 |

かな？自信なし

## 今回のプロジェクトに関して
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

## 上記の問題点
上記の話はメソッド内で完結している話であり、クラス間での試験までの話ではない。

Googleでは
- Small Tests(Sテスト)
- Medium Tests(Mテスト)
- Large Tests(Lテスト)
とレベル分けをすることでテストレベルを分類化しています。


#### Sテストとは
- 単一のクラスや関数の振る舞いを確かめる小さなＳテスト
- コードの品質向上に役立つ

- Sテストはクラス内の試験とさせてください。
- ↑※厳密には違いますがチームの共通認識を持たせるためにSテスト＝クラス内試験という認識にさせてください。

#### Mテストとは
- １つ以上のモジュールの統合度合いを確かめる
- プロダクトの品質向上に役立つ
- DI(Dependency Injection)、mockという考え方が必要になってくる（今回の説明では除外します。)

- ※厳密にはSテストでもDIを使う場面はありますが少し除外させてください。

> 例：mocker、各種モックツール

#### Lテストとは
- 高水準で動作し、全体としてのアプリケーションの動作をチェックする
- プロダクトの品質向上に役立つ
- E2Eと呼ばれる試験もここに入る。

> 例：Selenium,Postman

## 今回のプロジェクトに関して
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

## テストコードを書くコツ
- 巨大なメソッドを作るとテストコードが大変
 - 循環的複雑度が高いものは基本的にテストコードしにくい
- 意味のある単位で分割していく。
 - （意味がある単位に{無理やり}作りたければTDDなど調べてみてください。ライオンのスタンドを使う人に出会えます)
- privateのmethodの試験はしないです。（ライオンのスタンドの人曰く）
- ↑厳密にはなにかやろうと思えばやれたりしますが、そもそもpublicな部分からprivateを呼んでいるはずなのでそちらで担保ができるはずです。またテストしたいためにプロダクト用のコードをpublicにするのは論外かなと思います。


### 最後に
テストコードはメンテナンスしないとすぐに陳腐化します。

陳腐化したコードが数個超えた時点で1メンバーで対応できる工数ではなくなり、

誰もテストコードを触りたくなりなくなります。

そのため習慣化するために必要なことは開発フローの一部としてしまう方法です。

=>Continuous Integration　(CI) と呼ばれます。

=>将来的にCIしていくべきだと思っています。

=>開発フローの一部として入っているsiderもある種コード品質向上のためのCIの一部とも言えると思っています。

